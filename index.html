<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

        /* === ì—ë””í„° UI ë ˆì´ì•„ì›ƒ (í™”ë©´ ë¶„í• ) === */
        body {
            margin: 0;
            padding: 0;
            background-color: #f2f4f6; /* í† ìŠ¤ ìŠ¤íƒ€ì¼: ë°ì€ íšŒìƒ‰ ë°°ê²½ */
            font-family: 'Pretendard', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }

        /* ì™¼ìª½: ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            width: 400px;
            background: #fff;
            padding: 30px;
            box-sizing: border-box;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 700;
            font-size: 14px;
            color: #4e5968; /* í† ìŠ¤ ìŠ¤íƒ€ì¼: ë¶€ë“œëŸ¬ìš´ í…ìŠ¤íŠ¸ ì»¬ëŸ¬ */
            margin-bottom: 4px;
        }

        .control-group input, .control-group textarea, .control-group select {
            padding: 12px 16px;
            border: 1px solid #e5e8eb;
            border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            background-color: #f9fafb;
            font-family: inherit;
            font-size: 15px;
            color: #333;
            transition: all 0.2s;
            outline: none;
        }

        .control-group input:focus, .control-group textarea:focus, .control-group select:focus {
            border-color: #3182f6; /* í† ìŠ¤ ë¸”ë£¨ í¬ì¸íŠ¸ */
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(49, 130, 246, 0.1);
        }
        
        .control-group textarea {
            resize: vertical;
            height: 80px;
        }

        .btn-download {
            background-color: #3182f6; /* í† ìŠ¤ ë¸”ë£¨ */
            color: white;
            border: none;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.2s;
            box-shadow: 0 4px 10px rgba(49, 130, 246, 0.2);
        }
        .btn-download:hover { background-color: #1b64da; transform: translateY(-2px); }

        .btn-secondary {
            background-color: #fff;
            color: #333;
            border: 1px solid #d1d6db;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            flex: 1;
        }
        .btn-secondary:hover { background-color: #f2f4f6; }

        /* ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-area {
            flex: 1;
            background-color: #f0f2f5;
            display: flex;
            overflow: auto;
            padding: 40px;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ ë³´ì¡° */
        }

        /* ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        @media screen and (max-width: 1024px) {
            body {
                flex-direction: column;
                overflow: auto;
                height: auto;
            }
            .control-panel {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .preview-area {
                display: block;
                padding: 20px 0;
                overflow: hidden;
            }
        }

        /* === ì—¬ê¸°ì„œë¶€í„°ëŠ” ì›ë˜ ë¦¬í¬íŠ¸ CSS (ìŠ¤ì½”í”„ ë³´í˜¸) === */
        :root {
            --main-color: #d32f2f;
            --bg-accent: #ffebee;
            --text-grey: #555;
            --line-grey: #e0e0e0;
        }

        .report-card {
            width: 210mm;
            height: 297mm;
            padding: 20mm;
            box-sizing: border-box;
            background-color: #ffffff;
            position: relative;
            margin: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.05); /* ë” ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
            /* ìŠ¤ì¼€ì¼ ì¡°ì •ì€ JSë¡œ ì²˜ë¦¬ (ë°˜ì‘í˜•) */
            transform-origin: top center;
        }

        /* í—¤ë” */
        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 25px;
        }
        .student-name { font-size: 32px; font-weight: 800; color: #000; }
        .report-date { font-size: 16px; color: #555; font-weight: 500; }

        .section-wrapper { margin-bottom: 24px; position: relative; }
        .section-title {
            font-size: 18px; color: #333; font-weight: 700; margin-bottom: 12px;
            display: flex; align-items: center;
        }
        .section-title::before {
            content: ''; display: inline-block; width: 6px; height: 6px;
            background-color: var(--main-color); border-radius: 50%; margin-right: 8px;
        }

        /* ì„±ì  ì„¹ì…˜ */
        .score-box { margin-bottom: 15px; }
        .current-score {
            font-size: 64px; font-weight: 900; color: var(--main-color);
            line-height: 1; margin-bottom: 15px;
        }
        .current-score span { font-size: 24px; color: #777; font-weight: 500; margin-left: 4px; }

        /* ê·¸ë˜í”„ */
        .graph-container {
            width: 100%; height: 140px; position: relative;
            background-color: #fafafa; border-radius: 4px;
            padding: 25px 0 10px 0; box-sizing: border-box;
            border: 1px solid #eee; display: flex; flex-direction: column; justify-content: space-between;
        }
        .chart-wrapper { padding: 0 20px; height: 80px; }
        svg.line-chart { width: 100%; height: 100%; overflow: visible; }
        .chart-line { fill: none; stroke: var(--main-color); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; transition: all 0.5s ease;}
        .chart-dot { fill: #fff; stroke: var(--main-color); stroke-width: 2.5; r: 5; transition: all 0.5s ease; }
        .chart-dot.active { fill: var(--main-color); r: 6; }
        .chart-label { font-size: 14px; font-weight: 700; fill: var(--main-color); text-anchor: middle; transition: all 0.5s ease; }
        .chart-label.past { fill: #999; font-weight: 500; }

        .graph-label {
            display: flex; justify-content: space-between; font-size: 12px; color: #888;
            padding: 0 5px; margin-top: 5px;
        }
        .graph-label span { width: 50px; text-align: center; }
        .graph-label span.active-date { color: var(--main-color); font-weight: 700; }

        /* íƒœê·¸ */
        .weakness-tags { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .tag {
            font-size: 13px; background-color: var(--bg-accent); color: var(--main-color);
            padding: 5px 12px; border-radius: 15px; font-weight: 600;
        }

        /* ê¸°íƒ€ ì„¹ì…˜ (ê³¼ì œ, ì§„ë„ ë“±ì€ ìƒëµí•˜ì§€ ì•Šê³  ìœ ì§€) */
        .homework-header { display: flex; justify-content: space-between; font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px; }
        .percent { color: var(--main-color); font-weight: 800; }
        .progress-bg { width: 100%; height: 12px; background-color: #eee; border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; background-color: var(--main-color); width: 95%; border-radius: 6px; transition: width 0.5s; }
        .homework-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; }
        .homework-list li { font-size: 14px; color: #555; display: flex; align-items: center; }
        .homework-list li::before { content: 'âœ“'; color: var(--main-color); font-weight: bold; font-size: 12px; margin-right: 8px; width: 12px; }
        .homework-list li.incomplete::before { content: '-'; color: #ccc; }

        /* ì´ë²ˆ ì£¼ì°¨ ê³¼ì œ ë¦¬ìŠ¤íŠ¸ (í•˜ì´í”ˆ ìŠ¤íƒ€ì¼) */
        .notice-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; }
        .notice-list li { font-size: 14px; color: #555; display: flex; align-items: flex-start; }
        .notice-list li::before { content: '-'; color: var(--main-color); font-weight: bold; font-size: 12px; margin-right: 8px; width: 12px; flex-shrink: 0; margin-top: 5px; }

        /* ê³¼ì œ ë‚ ì§œ í‘œì‹œìš© ìŠ¤íƒ€ì¼ */
        .hw-date {
            font-size: 14px; color: #888; font-weight: 500; margin-left: 8px;
        }

        /* ì§„ë„ */
        .progress-row { display: flex; gap: 20px; }
        .progress-item {
            flex: 1; background-color: #fcfcfc; border: 1px solid #eee; border-left: 4px solid #ddd;
            border-radius: 4px; padding: 15px;
        }
        .progress-item.current {
            border-left-color: var(--main-color); background-color: #fff;
            border-top: 1px solid #eee; border-right: 1px solid #eee; border-bottom: 1px solid #eee;
        }
        .progress-label { font-size: 13px; color: #888; font-weight: 700; margin-bottom: 6px; display: block; }
        .progress-content { font-size: 15px; color: #333; line-height: 1.4; font-weight: 500; }
        .book-badge { font-size: 11px; background: #eee; color: #555; padding: 2px 6px; border-radius: 3px; margin-right: 5px; vertical-align: middle; }

        /* ì•Œë¦¼ì¥ (ìƒˆë¡œ ì¶”ê°€) */
        .notice-box {
            background-color: #f9fafb; /* í† ìŠ¤ ìŠ¤íƒ€ì¼: ë°ì€ íšŒìƒ‰ ë°°ê²½ */
            border: 1px solid #e5e8eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .footer-area {
            position: absolute; bottom: 20mm; left: 20mm; right: 20mm;
        }
        /* ì½”ë©˜íŠ¸ */
        .comment-box { 
            background-color: #f2f4f6; color: #333; padding: 20px 25px; border-radius: 20px; 
            border: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .comment-text { font-size: 15px; line-height: 1.4; font-weight: 600; white-space: pre-line; flex: 1; }
        .teacher-sign { margin-left: 20px; white-space: nowrap; font-size: 14px; font-weight: 800; color: var(--main-color); }

        .percent-badge {
            display: inline-flex; align-items: center;
            padding: 5px 14px; border-radius: 30px;
            background-color: rgba(0, 0, 0, 0.02); /* ë” íˆ¬ëª…í•˜ê²Œ */
            border: 1px solid rgba(0, 0, 0, 0.05); /* ìŠ¤í‹°ì»¤ ê²½ê³„ì„  ëŠë‚Œ */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            margin-left: auto;
            gap: 6px;
        }
        .badge-label {
            font-size: 11px; color: #8b95a1; font-weight: 600; letter-spacing: -0.2px;
        }
        .badge-value {
            font-size: 18px; color: #8b95a1; font-weight: 800; letter-spacing: -0.5px;
        }

    </style>
</head>
<body>

    <div class="control-panel">
        <h2>ğŸ“ ë¦¬í¬íŠ¸ ì—ë””í„°</h2>
        
        <div class="control-group">
            <label>í•™ìƒ ì´ë¦„</label>
            <input type="text" id="inputName" value="ê¹€ì¬í™˜" oninput="updateText('studentName', this.value)">
        </div>
        
        <div class="control-group">
            <label>ì˜¤ëŠ˜ ë‚ ì§œ (ìˆ˜ì—…ì¼)</label>
            <div style="display: flex; gap: 5px;">
                <select id="selYear" onchange="updateAllDates()" style="flex:1;"></select>
                <select id="selMonth" onchange="updateAllDates()" style="flex:1;"></select>
                <select id="selDay" onchange="updateAllDates()" style="flex:1;"></select>
            </div>
        </div>

        <div class="control-group">
            <label>ë‹¤ìŒ ìˆ˜ì—… ë‚ ì§œ</label>
            <input type="date" id="inputNextClassDate" onchange="updateAllDates()">
        </div>

        <div class="control-group">
            <label>ìµœê·¼ ì„±ì  (1~6ê°œ, ì½¤ë§ˆ êµ¬ë¶„)</label>
            <input type="text" id="inputScores" value="" oninput="updateGraphWrapper()">
            <small style="color:#666; font-size:12px;">ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê³µë€ ì²˜ë¦¬ë©ë‹ˆë‹¤.</small>
        </div>

        <div class="control-group">
            <label>ì„±ì  ë‚ ì§œ ë¼ë²¨ (ì½¤ë§ˆ êµ¬ë¶„, ë§ˆì§€ë§‰ì€ ì˜¤ëŠ˜ ë‚ ì§œ ìë™)</label>
            <input type="text" id="inputDates" value="" oninput="updateGraphWrapper()">
        </div>

        <div class="control-group">
            <label>ì•½ì  íƒœê·¸ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
            <input type="text" id="inputTags" value="" oninput="updateTags(this.value)">
        </div>

        <div class="control-group">
            <label>ê³¼ì œ ì´í–‰ë¥  (%)</label>
            <input type="number" id="inputHwPercent" value="" oninput="updateHomework(this.value)">
        </div>

        <div class="control-group">
            <label>ì €ë²ˆ ì£¼ì°¨ ê³¼ì œ (ì¤„ë°”ê¿ˆ êµ¬ë¶„, 'ë¯¸ì™„ë£Œ' í¬í•¨ ì‹œ ì²´í¬ í•´ì œ)</label>
            <textarea id="inputHwList" oninput="updateHomeworkList(this.value)"></textarea>
        </div>

        <div class="control-group">
            <label>í˜„ì¬ ì§„ë„ (êµì¬ / ë‹¨ì› / ìƒì„¸)</label>
            <input type="text" id="inCurBook" value="ìˆ˜ì—´(ëŒ€ìˆ˜)" placeholder="êµì¬ëª…" oninput="updateProgress()">
            <input type="text" id="inCurChap" value="" placeholder="ë‹¨ì›ëª…" oninput="updateProgress()">
            <textarea id="inCurDetail" placeholder="ìƒì„¸ ë‚´ìš©" oninput="updateProgress()"></textarea>
        </div>

        <div class="control-group">
            <label>ë‹¤ìŒ ì§„ë„ (êµì¬ / ë‹¨ì› / ìƒì„¸)</label>
            <input type="text" id="inNextBook" value="ìˆ˜ì—´(ëŒ€ìˆ˜)" placeholder="êµì¬ëª…" oninput="updateProgress()">
            <input type="text" id="inNextChap" value="" placeholder="ë‹¨ì›ëª…" oninput="updateProgress()">
            <textarea id="inNextDetail" placeholder="ìƒì„¸ ë‚´ìš©" oninput="updateProgress()"></textarea>
        </div>

        <div class="control-group">
            <label>ì´ë²ˆ ì£¼ì°¨ ê³¼ì œ (ìƒì„¸)</label>
            <textarea id="inputNotice" placeholder="ì˜ˆ: ìˆ˜í•™ ìµí˜ì±… p.30~40 í’€ì–´ì˜¤ê¸°" oninput="updateNoticeList(this.value)"></textarea>
        </div>

        <div class="control-group">
            <label>ê°•ì‚¬ ì„œëª…</label>
            <input type="text" id="inputTeacher" value="" placeholder="ì˜ˆ: From. ìµœì¤€í™” T" oninput="updateText('teacherSign', this.value)">
        </div>

        <div class="control-group">
            <label>í•œì¤„ ì½”ë©˜íŠ¸</label>
            <textarea id="inputComment" style="height:50px;" oninput="updateText('commentBody', this.value)"></textarea>
        </div>

        <!-- íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°ìš© hidden input -->
        <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="loadDataFromFile(this)">

        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn-secondary" onclick="saveDataToFile()">ğŸ’¾ íŒŒì¼ë¡œ ì €ì¥</button>
            <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>

        <button class="btn-download" onclick="downloadReport()">ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
    </div>

    <div class="preview-area">
        <div class="report-card" id="reportCard">
            <div class="header">
                <div class="student-name"><span id="studentName"></span> í•™ìƒ</div>
                <div class="report-date" id="reportDate">2025ë…„ 11ì›” 28ì¼ (ê¸ˆ)</div>
            </div>

            <div class="section-wrapper">
                <div class="section-title">ì¼ì¼ í…ŒìŠ¤íŠ¸ ì„±ì </div>
                <div class="score-box">
                    <div class="current-score">
                        <span id="displayScore" style="font-size:64px; font-weight:900; color:var(--main-color); margin:0;">92</span>
                        <span>ì </span>
                    </div>
                    
                    <div class="graph-container">
                        <div class="chart-wrapper">
                            <svg class="line-chart" id="scoreGraph" viewBox="0 0 660 80" preserveAspectRatio="none">
                                </svg>
                        </div>
                        <div class="graph-label" id="dateLabels">
                            </div>
                    </div>
                </div>

                <div class="weakness-tags" id="tagContainer">
                    </div>
            </div>

            <div class="section-wrapper">
                <div class="section-title">ìˆ˜ì—… ì§„ë„ í˜„í™©</div>
                <div class="progress-row">
                    <div class="progress-item current">
                        <span class="progress-label" style="color:var(--main-color);">
                            í˜„ì¬ ì§„ë„ <span id="outCurDateText"></span>
                        </span>
                        <div class="progress-content">
                            <span class="book-badge" id="outCurBook">ìˆ˜í•™I</span>
                            <span id="outCurChap">03. ì§€ìˆ˜í•¨ìˆ˜ì™€ ë¡œê·¸í•¨ìˆ˜</span><br>
                            <span id="outCurDetail" style="font-size:13px; color:#666; display:block; margin-top:4px; white-space: pre-line;">
                                - ì§€ìˆ˜/ë¡œê·¸í•¨ìˆ˜ì˜ ê·¸ë˜í”„ ì„±ì§ˆ
                            </span>
                        </div>
                    </div>
                    <div class="progress-item">
                        <span class="progress-label">
                            ë‹¤ìŒ ì§„ë„ <span id="outNextDateText"></span>
                        </span>
                        <div class="progress-content">
                            <span class="book-badge" id="outNextBook">ìˆ˜í•™I</span>
                            <span id="outNextChap">04. ë¡œê·¸í•¨ìˆ˜ì˜ í™œìš©</span><br>
                            <span id="outNextDetail" style="font-size:13px; color:#666; display:block; margin-top:4px; white-space: pre-line;">
                                - ë¡œê·¸ë°©ì •ì‹ê³¼ ë¶€ë“±ì‹
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-wrapper" id="lastHwSection">
                <div class="section-title" style="display:flex; align-items:center;">
                    ì €ë²ˆ ì£¼ì°¨ ê³¼ì œ
                    <span id="lastHwDate" class="hw-date"></span>
                    <span id="hwPercentBadge" class="percent-badge" style="display:none;"></span>
                </div>
                <div class="notice-box">
                    <ul class="homework-list" id="homeworkList">
                        <!-- JSë¡œ ìƒì„± -->
                    </ul>
                </div>
            </div>

            <div class="section-wrapper">
                <div class="section-title">
                    ì´ë²ˆ ì£¼ì°¨ ê³¼ì œ
                    <span id="thisHwDate" class="hw-date"></span>
                </div>
                <div class="notice-box" id="noticeBox"></div>
            </div>

            <div class="footer-area">
                <div class="section-title">ì„ ìƒë‹˜ì˜ í•œ ì¤„ ì½”ë©˜íŠ¸</div>
                <div class="comment-box">
                    <div class="comment-text" id="commentBody"></div>
                    <div class="teacher-sign" id="teacherSign"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì´ˆê¸° ì‹¤í–‰
        window.onload = function() {
            initDateSelectors(); // ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”
            updateLayoutScale(); // ì´ˆê¸° ìŠ¤ì¼€ì¼ ì¡°ì •
            window.addEventListener('resize', updateLayoutScale); // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
            // updateGraphWrapperëŠ” updateAllDates ì•ˆì—ì„œ í˜¸ì¶œë¨
            updateTags(document.getElementById('inputTags').value);
            updateHomework(document.getElementById('inputHwPercent').value);
            updateHomeworkList(document.getElementById('inputHwList').value);
            updateProgress(); // ì§„ë„ ì´ˆê¸°í™”
            updateNoticeList(document.getElementById('inputNotice').value);
            updateText('commentBody', document.getElementById('inputComment').value);
            updateText('teacherSign', document.getElementById('inputTeacher').value);
        };

        // ë‹¨ì¶•í‚¤ ì €ì¥ (Ctrl + S)
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDataToFile();
            }
        });

        // 0. í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ë¯¸ë¦¬ë³´ê¸° ìŠ¤ì¼€ì¼ ì¡°ì • (ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘ ëŒ€ì‘)
        function updateLayoutScale() {
            const card = document.getElementById('reportCard');
            const container = document.querySelector('.preview-area');
            
            // ë¦¬í¬íŠ¸ ì¹´ë“œì˜ ì‹¤ì œ ë„ˆë¹„ (210mm)
            const cardWidth = card.offsetWidth; 
            const containerWidth = container.clientWidth;
            const padding = 40; // ì¢Œìš° ì—¬ë°±
            
            let scale = (containerWidth - padding) / cardWidth;
            
            // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ ì œí•œ (ê¸°ì¡´ 0.8~0.9 ìˆ˜ì¤€ ìœ ì§€)
            if (window.innerWidth > 1024) {
                if (scale > 0.85) scale = 0.85;
            } else {
                // ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ ë„ˆë¹„ì— ë§ì¶¤ (ìµœëŒ€ 1)
                if (scale > 1) scale = 1;
            }
            
            card.style.transform = `scale(${scale})`;
            
            // ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒì—ì„œ ë†’ì´ ë³´ì • (transformì€ ê³µê°„ì„ ì°¨ì§€í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°•ì œ ë†’ì´ ì§€ì •)
            if (window.innerWidth <= 1024) {
                container.style.height = (card.offsetHeight * scale + 100) + 'px';
            } else {
                container.style.height = 'auto';
            }
        }

        // 1. ë‹¨ìˆœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateText(elementId, value) {
            const el = document.getElementById(elementId);
            el.innerText = value;
            if(window.MathJax) MathJax.typesetPromise([el]).catch(()=>{});
        }

        // 1-1. ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
        function initDateSelectors() {
            const yearSel = document.getElementById('selYear');
            const monthSel = document.getElementById('selMonth');
            const daySel = document.getElementById('selDay');

            // ë…„ë„ (2024 ~ 2030)
            for(let y=2024; y<=2030; y++) yearSel.add(new Option(y + 'ë…„', y));
            // ì›”
            for(let m=1; m<=12; m++) monthSel.add(new Option(m + 'ì›”', m));
            // ì¼
            for(let d=1; d<=31; d++) daySel.add(new Option(d + 'ì¼', d));

            // ê¸°ë³¸ê°’ ì„¤ì • (2026ë…„ 1ì›” 1ì¼)
            yearSel.value = 2026;
            monthSel.value = 1;
            daySel.value = 17;

            // ë‹¤ìŒ ìˆ˜ì—… ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('inputNextClassDate').value = '2026-01-22';

            updateAllDates();
        }

        // ë‚ ì§œ ê´€ë ¨ í†µí•© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAllDates() {
            const y = document.getElementById('selYear').value;
            const m = document.getElementById('selMonth').value;
            const d = document.getElementById('selDay').value;
            
            const dateObj = new Date(y, m-1, d);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = days[dateObj.getDay()];

            // 1. í—¤ë” ë‚ ì§œ
            const dateStr = `${y}ë…„ ${m}ì›” ${d}ì¼ (${dayName})`;
            document.getElementById('reportDate').innerText = dateStr;

            // ì˜¤ëŠ˜ ë‚ ì§œ ë‹¨ì¶•í˜• (MM.DD)
            const todayShort = `${m.padStart(2, '0')}.${d.padStart(2, '0')}`;

            // 2. ë‹¤ìŒ ìˆ˜ì—… ë‚ ì§œ
            const nextDateVal = document.getElementById('inputNextClassDate').value;
            let nextShort = 'ë¯¸ì •';
            if(nextDateVal) {
                const [ny, nm, nd] = nextDateVal.split('-');
                nextShort = `${nm.padStart(2, '0')}.${nd.padStart(2, '0')}`;
            }

            // 3. ì§„ë„ ë° ê³¼ì œ ë‚ ì§œ ë§¤ì¹­
            document.getElementById('outCurDateText').innerText = `(~${todayShort})`;
            document.getElementById('outNextDateText').innerText = `(${nextShort}~)`;
            
            const lastHwDateEl = document.getElementById('lastHwDate');
            if(lastHwDateEl) lastHwDateEl.innerText = `(~${todayShort})`;

            const thisHwDateEl = document.getElementById('thisHwDate');
            if(thisHwDateEl) thisHwDateEl.innerText = `(~${nextShort})`;

            // 4. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ ë‚ ì§œ ì „ë‹¬)
            updateGraphWrapper(todayShort);
        }

        function updateGraphWrapper(todayShortStr) {
            // updateAllDatesì—ì„œ í˜¸ì¶œë˜ì§€ ì•Šê³  ì§ì ‘ í˜¸ì¶œë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë‚ ì§œ ë‹¤ì‹œ ê³„ì‚°
            if(!todayShortStr) {
                const m = document.getElementById('selMonth').value;
                const d = document.getElementById('selDay').value;
                todayShortStr = `${m.padStart(2, '0')}.${d.padStart(2, '0')}`;
            }

            const scoreStr = document.getElementById('inputScores').value;
            const dateStr = document.getElementById('inputDates').value;
            updateGraph(scoreStr, dateStr, todayShortStr);
        }

        // 2. ê·¸ë˜í”„ ê·¸ë¦¬ê¸° ë¡œì§ (í•µì‹¬!)
        function updateGraph(scoreStr, dateStr, todayShortStr) {
            // ë¹ˆ ê°’ í•„í„°ë§í•˜ì—¬ ìœ íš¨í•œ ìˆ«ìë§Œ ë°°ì—´ë¡œ ë§Œë“¦
            const scores = scoreStr.split(',').map(s => s.trim()).filter(s => s !== '').map(Number);
            let dates = dateStr.split(',').map(d => d.trim());

            // ë§ˆì§€ë§‰ ë‚ ì§œë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê°•ì œ ë§¤ì¹­ (ë°ì´í„°ê°€ ìˆì„ ê²½ìš°)
            if (scores.length > 0) {
                // dates ë°°ì—´ ê¸¸ì´ê°€ scoresë³´ë‹¤ ì§§ìœ¼ë©´ ì±„ì›Œë„£ê³ , ê°™ê±°ë‚˜ ê¸¸ë©´ ë§ˆì§€ë§‰ì„ êµì²´
                while(dates.length < scores.length) {
                    dates.push('');
                }
                dates[scores.length - 1] = todayShortStr;
            }

            const svg = document.getElementById('scoreGraph');
            
            // í˜„ì¬ ì ìˆ˜(ë§ˆì§€ë§‰ ì ìˆ˜) ì—…ë°ì´íŠ¸
            const currentScore = scores.length > 0 ? scores[scores.length - 1] : '-';
            document.getElementById('displayScore').innerText = currentScore;

            // ê·¸ë˜í”„ ì¢Œí‘œ ê³„ì‚° (ViewBox: 0 0 660 80)
            // ë°ì´í„° ê°œìˆ˜ì™€ ìƒê´€ì—†ì´ 6ì¹¸ ê¸°ì¤€ ê³ ì • ê°„ê²© (660 / 5 = 132)
            const count = scores.length;
            const step = 132;
            
            const points = scores.map((score, index) => {
                const x = index * step; // ì¸ë±ìŠ¤ì— ë”°ë¼ ê³ ì • ìœ„ì¹˜
                // ì ìˆ˜ ë§¤í•‘: 60~100ì  ì‚¬ì´ë¥¼ ê·¸ë˜í”„ì— í‘œí˜„í•œë‹¤ê³  ê°€ì • (ë³€ë™í­ì„ ì˜ ë³´ì—¬ì£¼ê¸° ìœ„í•´)
                // ë§Œì•½ 0~100 ì ˆëŒ€í‰ê°€ë¼ë©´ ê³µì‹ì„ ë°”ê¾¸ë©´ ë¨. ì—¬ê¸°ì„  ì‹œê°ì  íš¨ê³¼ë¥¼ ìœ„í•´ ì¡°ì •í•¨.
                let y = 80 - ((score - 50) * 1.5); 
                if(y < 5) y = 5; if(y > 75) y = 75; // ê·¸ë˜í”„ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ
                return {x, y, score};
            });

            // Polyline ìƒì„±
            const polylinePoints = points.map(p => `${p.x},${p.y}`).join(' ');
            
            let svgContent = `<polyline points="${polylinePoints}" class="chart-line" />`;

            // ì (Circle)ê³¼ í…ìŠ¤íŠ¸(Text) ìƒì„±
            points.forEach((p, idx) => {
                const isActive = idx === points.length - 1 ? 'active' : '';
                const isPast = idx === points.length - 1 ? '' : 'past';
                
                svgContent += `
                    <circle cx="${p.x}" cy="${p.y}" class="chart-dot ${isActive}" />
                    <text x="${p.x}" y="${p.y - 15}" class="chart-label ${isPast}">${p.score}</text>
                `;
            });

            svg.innerHTML = svgContent;

            // ë‚ ì§œ ë¼ë²¨ ì—…ë°ì´íŠ¸ (ê·¸ë˜í”„ì™€ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ ìœ„ì¹˜ ë°°ë¶„)
            const container = document.getElementById('dateLabels');
            let html = '';
            
            // í•­ìƒ 6ê°œì˜ ìŠ¬ë¡¯ì„ ìƒì„±í•˜ì—¬ ìœ„ì¹˜ë¥¼ ê³ ì • (justify-content: space-betweenì— ëŒ€ì‘)
            for(let i=0; i<6; i++) {
                const date = (i < count && dates[i]) ? dates[i] : '';
                const isActive = i === count - 1 ? 'active-date' : '';
                // flex-box justify-content: space-betweenì„ ì‚¬ìš©í•˜ë¯€ë¡œ spanë§Œ ë‚˜ì—´í•˜ë©´ ë¨
                html += `<span class="${isActive}">${date}</span>`;
            }
            container.innerHTML = html;
        }

        // 4. íƒœê·¸ ì—…ë°ì´íŠ¸
        function updateTags(tagStr) {
            const tags = tagStr.split(',').map(t => t.trim()).filter(t => t !== '');
            const container = document.getElementById('tagContainer');
            
            let html = '';
            tags.forEach(tag => {
                // í•´ì‹œíƒœê·¸ê°€ ì—†ìœ¼ë©´ ë¶™ì—¬ì¤Œ
                const text = tag.startsWith('#') ? tag : '#' + tag.replace(/ /g, '_'); 
                html += `<span class="tag">${text}</span>`;
            });
            container.innerHTML = html;
        }

        // 5. ê³¼ì œ ì´í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateHomework(percent) {
            const badge = document.getElementById('hwPercentBadge');
            if (percent && percent.trim() !== '') {
                badge.style.display = 'inline-flex';
                badge.innerHTML = `<span class="badge-label">ê³¼ì œ ì´í–‰ë¥ </span><span class="badge-value">${percent}%</span>`;
            } else {
                badge.style.display = 'none';
            }
        }

        // 7. ê³¼ì œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateHomeworkList(text) {
            const list = document.getElementById('homeworkList');
            const section = document.getElementById('lastHwSection');

            if (!text.trim()) {
                if (section) section.style.display = 'none';
                list.innerHTML = '';
                return;
            }
            if (section) section.style.display = 'block';

            const lines = text.split('\n');
            let html = '';
            
            lines.forEach(line => {
                if(!line.trim()) return;
                // 'ë¯¸ì™„ë£Œ' í…ìŠ¤íŠ¸ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ incomplete í´ë˜ìŠ¤ ì¶”ê°€
                const isIncomplete = line.includes('ë¯¸ì™„ë£Œ');
                // 'ë¯¸ì™„ë£Œ' í…ìŠ¤íŠ¸ ìœ ì§€
                let displayText = line.trim();
                
                const className = isIncomplete ? 'incomplete' : '';
                html += `<li class="${className}">${displayText}</li>`;
            });
            list.innerHTML = html;
            if(window.MathJax) MathJax.typesetPromise([list]).catch(()=>{});
        }

        // 7-1. ì´ë²ˆ ì£¼ì°¨ ê³¼ì œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (í•˜ì´í”ˆ ìŠ¤íƒ€ì¼)
        function updateNoticeList(text) {
            const box = document.getElementById('noticeBox');
            const lines = text.split('\n');
            let html = '<ul class="notice-list">';
            
            lines.forEach(line => {
                if(!line.trim()) return;
                html += `<li>${line.trim()}</li>`;
            });
            html += '</ul>';
            box.innerHTML = html;
            if(window.MathJax) MathJax.typesetPromise([box]).catch(()=>{});
        }

        // 8. ì§„ë„ í˜„í™© ì—…ë°ì´íŠ¸
        function updateProgress() {
            // ë‚ ì§œëŠ” updateAllDates()ì—ì„œ ì²˜ë¦¬í•¨

            document.getElementById('outCurBook').innerText = document.getElementById('inCurBook').value;
            document.getElementById('outCurChap').innerText = document.getElementById('inCurChap').value;
            document.getElementById('outCurDetail').innerText = document.getElementById('inCurDetail').value;

            document.getElementById('outNextBook').innerText = document.getElementById('inNextBook').value;
            document.getElementById('outNextChap').innerText = document.getElementById('inNextChap').value;
            document.getElementById('outNextDetail').innerText = document.getElementById('inNextDetail').value;

            if(window.MathJax) {
                const elements = [
                    document.getElementById('outCurBook'), document.getElementById('outCurChap'), document.getElementById('outCurDetail'),
                    document.getElementById('outNextBook'), document.getElementById('outNextChap'), document.getElementById('outNextDetail')
                ];
                MathJax.typesetPromise(elements).catch(()=>{});
            }
        }

        // 6. ì´ë¯¸ì§€ ì €ì¥ (html2canvas ì‚¬ìš©)
        function downloadReport() {
            const element = document.getElementById('reportCard');
            // ìŠ¤ì¼€ì¼ ë³µêµ¬ í›„ ìº¡ì²˜ (ê³ í•´ìƒë„ë¥¼ ìœ„í•´)
            const originalTransform = element.style.transform;
            element.style.transform = "none";
            
            html2canvas(element, { 
                scale: 4, // 4ë°°ìœ¨ (ì´ˆê³ í™”ì§ˆ, ì¸ì‡„ìš© ìˆ˜ì¤€)
                useCORS: true,
                backgroundColor: "#ffffff",
                windowWidth: 2000, // ìº¡ì²˜ ì‹œ ë°ìŠ¤í¬íƒ‘ ë„ˆë¹„ ê¸°ì¤€ ë Œë”ë§ (ì¤„ë°”ê¿ˆ ê¹¨ì§ ë°©ì§€)
                imageTimeout: 0 // ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸° ì‹œê°„ ì œí•œ í•´ì œ
            }).then(canvas => {
                const link = document.createElement('a');
                const name = document.getElementById('inputName').value;
                link.download = `${name}_í•™ìŠµë¦¬í¬íŠ¸.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // ìº¡ì²˜ í›„ ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ ì¶•ì†Œ
                element.style.transform = originalTransform;
            });
        }

        // 9. ë°ì´í„° íŒŒì¼ ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°
        function saveDataToFile() {
            const data = {
                inputName: document.getElementById('inputName').value,
                selYear: document.getElementById('selYear').value,
                selMonth: document.getElementById('selMonth').value,
                selDay: document.getElementById('selDay').value,
                inputScores: document.getElementById('inputScores').value,
                inputDates: document.getElementById('inputDates').value,
                inputTags: document.getElementById('inputTags').value,
                inputHwPercent: document.getElementById('inputHwPercent').value,
                inputHwList: document.getElementById('inputHwList').value,
                inputNextClassDate: document.getElementById('inputNextClassDate').value,
                inCurBook: document.getElementById('inCurBook').value,
                inCurChap: document.getElementById('inCurChap').value,
                inCurDetail: document.getElementById('inCurDetail').value,
                inNextBook: document.getElementById('inNextBook').value,
                inNextChap: document.getElementById('inNextChap').value,
                inNextDetail: document.getElementById('inNextDetail').value,
                inputNotice: document.getElementById('inputNotice').value,
                inputTeacher: document.getElementById('inputTeacher').value,
                inputComment: document.getElementById('inputComment').value
            };
            
            const now = new Date();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            const name = data.inputName || 'student';
            link.download = `${name} - ${m}-${d}-${h}${min}.json`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function loadDataFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                
                    // ê° í•„ë“œ ê°’ ë³µì› (ì—†ëŠ” í•„ë“œëŠ” ê±´ë„ˆëœ€ -> í˜¸í™˜ì„± í™•ë³´)
                    for (const key in data) {
                        if (document.getElementById(key)) {
                            document.getElementById(key).value = data[key];
                        }
                    }
                
                    // í™”ë©´ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
                    updateAllDates();
                    updateTags(document.getElementById('inputTags').value);
                    updateHomeworkList(document.getElementById('inputHwList').value);
                    updateProgress();
                    updateNoticeList(document.getElementById('inputNotice').value);
                    updateText('commentBody', document.getElementById('inputComment').value);
                    updateText('teacherSign', document.getElementById('inputTeacher').value);
                    updateText('studentName', document.getElementById('inputName').value);
                    
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                } catch (e) {
                    console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
            input.value = ''; // ì´ˆê¸°í™”í•˜ì—¬ ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ í•¨
        }
    </script>
</body>
</html>
